name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: PROD_ENV_FILE
          script: |
            TARGET_DIR=~/domains/zrealatorz.com/public_html/CRM
            
            # Check if directory exists, if not create and clone
            if [ ! -d "$TARGET_DIR" ]; then
              echo "ðŸ“‚ Creating directory and cloning repo for the first time..."
              mkdir -p "$TARGET_DIR"
              git clone https://github.com/gwaez/realm-crm.git "$TARGET_DIR"
            fi
            
            # Navigate to directory
            cd "$TARGET_DIR"
            
            # Ensure we are on main branch and pull latest
            git checkout main
            git pull origin main
            
            # Create .env file for backend
            if [ ! -z "$PROD_ENV_FILE" ]; then
              echo "ðŸ”’ Creating .env file..."
              echo "$PROD_ENV_FILE" > backend/.env
            fi
            
            # Run deployment script
            chmod +x deploy.sh
            ./deploy.sh
      env:
        PROD_ENV_FILE: ${{ secrets.ENV_FILE }}
